---
title: "Zadanie 4.5"
author: "A.Brodecka, M.Stolarczyk"
date: "18 kwietnia 2017"
output: 
    html_document:
        toc: true   
        number_sections: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning =  FALSE, messages = FALSE)
library(dplyr)
```

# Podsumowanie 

Na podstawie analizy wariancji możemy stwierdzić, że istnieją istotne różnice
w proporcji poprawnie rozwiązanych zadań między studentami stosującymi różne
strategie (punkt 3).
W każdej dziedzinie pytań, najlepiej sobie radzą studenci, którzy szybko rozwiązują
zadania na początku testu, a wolno na końcu testu. Najsłabsze wyniki osiągają osoby,
które wolno rozwiązują zadania na początku testu, a szybko na końcu (punkt 4).

Na końcu dokumentu prezentujemy rankingi państw po względem poprawności
rozwiązywania zadań, oczyszczone z wpływu stosowanej strategii 
rozwiązywania zadań (punkt 5).

# Przygotowanie danych
```{r chunk1, echo=FALSE, results="hide", messages=FALSE, warning=FALSE}
library(dplyr)
library(stringi)
library(ggplot2)
library(DT)
library(tidyr)

dane <- readRDS("zadanie0_wynik.rds")
dane <- filter(dane, BOOKID >= 31 & BOOKID <= 61, !is.na(position))
klastry <- readRDS("klastry.rds")
dane %>% left_join(klastry, by="CNTSTUID") %>%
    filter(!is.na(type_final), type_final != "oth") -> 
    dane2
```

Na podstawie danych z zadania 0 dla każdego studenta obliczamy frakcję poprawnie
rozwiązanych zadań. Dodatkowo dołączamy kolumnę mówiącą o strategii stosowanej
przez studenta.
```{r chunk2, echo=FALSE}
dane2 %>%
    mutate(group = stri_sub(item, 2, 2)) %>%
    mutate(result = 0 + (result == "Full credit")) %>%
    group_by(group, CNTRYID, CNTSTUID) %>%
    summarise(result = mean(result, na.rm = TRUE),
              W_FSTUWT = unique(W_FSTUWT),
              type_final = unique(type_final)) %>%
    ungroup() ->
    student_results

knitr::kable(head(student_results))
```

# Wpływ strategii na końcowy wynik
Aby sprawdzić, czy stosowana strategia wpływa na wyniki testów, stosujemy analizę 
wariancji. Sprawdzamy istotność strategii i państwa oraz interakcji tych dwóch czynników. Poniżej przedstawiamy wyniki testów.

## Matematyka
```{r chunk3, echo=FALSE}
student_results %>%
    filter(group == "M") %>%
    aov(result ~ type_final * CNTRYID, ., weights = W_FSTUWT) ->
    anova_math

summary(anova_math)
```


## Czytanie
```{r chunk4, echo=FALSE}
student_results %>%
    filter(group == "R") %>%
    aov(result ~ type_final * CNTRYID, ., weights = W_FSTUWT) ->
    anova_read

summary(anova_read)
```

## Nauki przyrodnicze
```{r chunk5, echo=FALSE}
student_results %>%
    filter(group == "S") %>%
    aov(result ~ type_final * CNTRYID, ., weights = W_FSTUWT) ->
    anova_sci

summary(anova_sci)
```

## Komentarz
Wszystkie powyższe testy odrzucają hipotezy zerowe na poziomie istotności 0.05.
Zatem rodzaj stosowanej strategii, państwo oraz interakcje tych dwóch zmiennych 
mają wpływ na frakcję poprawnie rozwiązanych zadań.


# Oszacowanie wpływu strategii na końcowy wynik
Aby oszacować wpływ strategii na wyniki testów, oczysczamy wyniki z wpływu państw,
tj. odejmujemy od wyniku każdego studenta średni wynik w jego kraju i dodajemy 
średni wynik w całym badaniu. Następnie liczymy średnią z wyników w grupach
wyznaczonych przez stosowaną strategię. Średnie są ważone przez zmienną `W_FSTUWT`.


```{r chunk6, echo=FALSE}
student_results %>% 
    mutate(type_final = ordered(type_final, levels=c("01", "11", "00", "10"),
                                labels=c("wolno-szybko", "wolno-wolno",
                                         "szybko-szybko", "szybko-wolno"))) %>%
    mutate(group = ordered(group, levels=c("M", "S", "R"))) %>%
    group_by(group, CNTRYID) %>%
    mutate(result_cleaned = result - weighted.mean(result, W_FSTUWT, na.rm = TRUE)) %>%
    group_by(group) %>%
    mutate(result_cleaned = result_cleaned + weighted.mean(result, W_FSTUWT, na.rm = TRUE)) %>%
    group_by(group, type_final) %>%
    summarise(result_cleaned = weighted.mean(result_cleaned, W_FSTUWT, na.rm = TRUE)) %>%
    ggplot(aes(x=type_final, y = result_cleaned, group = group, fill = group)) +
    geom_bar(stat="identity", position=position_dodge()) +
    xlab("strategia") +
    ylab("średni wynik") + 
    scale_fill_discrete(name = "Rodzaj pytań")

```

Możemy zaobserwować, że najlepsze wyniki osiągają osoby, które na początku szybko
rozwiązują zadania, a później zwalniają. Najgorsze wyniki natomiast osiągają osoby,
które wolno roziązują początkowe zadania, a szybko końcowe zadania. Osoby, które 
wszystkie zadania rozwiązują szybko albo wszystkie wolno osiągają pośrednie wyniki.
Reguła ta jest taka sama w każdej grupie tematycznej pytań.

# Ranking państw po usunięciu wpływu strategii
Aby usunąć wpływ strategii z rankingu państw od wyniku każdego studenta odejmujemy
średnią wyników osób stosujących taką samą strategię i dodajemy średnią 
ogólną. Następnie liczymy średni wynik dla każdego państwa. Każdą średnią 
ważymy za pomocą zmiennej `W_FSTUWT`.

Poniżej prezentujemy tabelę z wynikami dla każdego państwa w każdej grupie 
tematycznej zadań.

```{r chunk7, echo=FALSE}
student_results %>%
    group_by(group, type_final) %>%
    mutate(result_cleaned = result - weighted.mean(result, W_FSTUWT, na.rm = TRUE)) %>%
    group_by(group) %>%
    mutate(result_cleaned = result_cleaned + weighted.mean(result, W_FSTUWT, na.rm = TRUE)) %>%
    group_by(group, CNTRYID) %>%
    summarise(result_cleaned = weighted.mean(result_cleaned, W_FSTUWT, na.rm = TRUE)) %>%
    ungroup() ->
    ranking
    
ranking %>% 
    mutate(group = c("M"="Matematyka", 
                     "R"="Czytanie",
                     "S"="Nauki przyrodnicze")[as.character(group)]) %>%
    spread(group, result_cleaned) %>%
    datatable()
```


# Kod
```{r chunk1, eval=FALSE}
```
```{r chunk2, eval=FALSE}
```
```{r chunk3, eval=FALSE}
```
```{r chunk4, eval=FALSE}
```
```{r chunk5, eval=FALSE}
```
```{r chunk6, eval=FALSE}
```
```{r chunk7, eval=FALSE}
```